name: Run Codex Prompt (DeepSeek)

on:
  workflow_dispatch: # Manuel çalıştırma için

jobs:
  run-codex:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout repo
        uses: actions/checkout@v4

      - name: 2. Install jq (JSON parser)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: 3. Prepare Prompt and Call DeepSeek API
        env:
          # Bu secret, bir sonraki adımda ekleyeceğin tek anahtardır
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          # Kullanılacak DeepSeek model adı (Örnek, kendi modelini yaz)
          DEEPSEEK_MODEL: deepseek-coder # veya deepseek-chat
        run: |
          echo "Starting DeepSeek run..."
          if [ -z "$DEEPSEEK_API_KEY" ]; then 
            echo "::error:: DEEPSEEK_API_KEY secret is not set."
            exit 1
          fi

          # codex_prompt.txt dosyasını JSON formatına çevir
          PROMPT_JSON=$(jq -Rs . < codex_prompt.txt)
          
          echo "Prompt file loaded. Calling DeepSeek API..."

          # DeepSeek API'sine curl ile istek at
          curl -s -X POST "https://api.deepseek.com/v1/chat/completions" \
            -H "Authorization: Bearer $DEEPSEEK_API_KEY" \
            -H "Content-Type: application/json" \
            -d "{
                  \"model\": \"${DEEPSEEK_MODEL}\",
                  \"messages\": [{\"role\": \"user\", \"content\": ${PROMPT_JSON}}],
                  \"max_tokens\": 4096,
                  \"temperature\": 0.0
                }" \
            > codex_response.json

          echo "DeepSeek response received."

      - name: 4. Upload Response as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: codex-response
          path: codex_response.json
